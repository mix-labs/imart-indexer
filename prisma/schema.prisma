datasource db {
    // could be postgresql or mysql
    provider = "mysql"
    url      = "mysql://root:root@127.0.0.1:3306/imart"
}

generator client {
    provider             = "prisma-client-py"
    recursive_type_depth = 5
    // previewFeatures      = ["interactiveTransactions"]
}

enum Chain {
    IC
    FLOW
    APTOS
}

enum MetadataType {
    VIDEO
    AUDIO
    IMAGE
    OTHER
}

enum OrderStatus {
    LISTING
    SOLD
    CANCELED
}

enum OfferStatus {
    CREATED
    ACCEPTED
    CANCELED
}

enum Operation {
    LIST
    UPDATE
    CANCEL
    SALE
}

enum SaleStatus {
    UNAUDITED
    UPCOMING
    LIVE
    ENDED
}

model Community {
    id           String      @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    name         String
    icon         String
    link         String
    Collection   Collection? @relation(fields: [collectionId], references: [id])
    collectionId String?     @db.VarChar(64)
}

model Sale {
    id               String      @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    collection       Collection? @relation(fields: [collectionId], references: [id])
    status           SaleStatus
    publicMintTime   DateTime
    expirationTime   DateTime?
    title            String
    description      String
    mintingEnabled   Boolean     @default(false)
    tokenSupply      BigInt
    mintedTokenCount BigInt      @default(0)
    mintPrice        Float
    mintPayload      String
    collectionId     String?     @db.VarChar(64)

    @@index([status])
}

model Comment {
    id           String   @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    collectionId String   @db.VarChar(64)
    tokenId      String   @db.VarChar(64)
    userId       String   @db.VarChar(64)
    content      String
    createTime   DateTime
    status       String

    @@index([userId, collectionId, tokenId])
}

model User {
    id          String  @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    chain       Chain
    address     String
    publicKey   String? @default("")
    name        String? @default("")
    logo        String? @default("")
    cover       String? @default("")
    description String? @default("")
    character   String? @default("")

    @@index([chain, address, publicKey])
}

model Collection {
    id              String       @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    rawCollectionId String
    chain           Chain
    metadataType    MetadataType
    category        String
    contractName    String
    contract        String       @default("")
    name            String
    creator         String
    description     String       @db.VarChar(400)
    cover           String?      @default("")
    logo            String?      @default("")
    maximum         BigInt       @default(0) @db.UnsignedBigInt
    volume          Float        @default(0)
    floorPrice      Float?
    uri             String?      @default("")
    supply          BigInt       @default(0) @db.UnsignedBigInt
    Sale            Sale[]
    communities     Community[]

    @@unique([chain, creator, name])
    @@index([chain, category, metadataType])
}

//**************************************************************************************************
// Aptos
//**************************************************************************************************
model AptosOrder {
    id           String      @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    collectionId String      @db.VarChar(64)
    seller       String
    buyer        String?
    price        Float
    currency     String      @default("")
    status       OrderStatus
    createTime   DateTime
    orderIndex   BigInt      @default(0) @db.UnsignedBigInt
    token        AptosToken? @relation(fields: [tokenId], references: [id])
    tokenId      String?     @db.VarChar(64)

    @@unique([tokenId, orderIndex])
    @@index([collectionId, tokenId, status, seller, orderIndex])
}

model AptosOrders {
    id           String      @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    tokenId      String      @db.VarChar(64)
    collectionId String      @db.VarChar(64)
    seller       String      @db.VarChar(66)
    buyer        String?     @db.VarChar(66)
    price        Float
    amount       Float       @default(1)
    currency     String      @default("")
    status       OrderStatus
    createTime   DateTime

    @@unique([tokenId, seller, status, createTime])
    @@index([collectionId, tokenId, status, seller])
}

model AptosToken {
    id              String       @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    collectionId    String       @db.VarChar(64)
    rawCollectionId String
    rawTokenId      String
    owner           String       @default("")
    creator         String       @default("")
    collection      String       @default("")
    name            String       @default("")
    description     String       @default("")
    uri             String       @default("")
    propertyVersion String       @default("0")
    seqno           BigInt       @default(0) @db.UnsignedBigInt
    AptosOrder      AptosOrder[]

    @@unique([rawCollectionId, rawTokenId])
    @@unique([creator, name, collection, propertyVersion])
    @@index([collectionId, owner])
}

model AptosTokenFavorited {
    id           String @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    tokenId      String @db.VarChar(64)
    collectionId String @db.VarChar(64)
    favoritedBy  String

    @@index([tokenId, collectionId, favoritedBy])
}

model AptosOffer {
    id           String      @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    tokenId      String      @db.VarChar(64)
    collectionId String      @db.VarChar(64)
    price        Float
    currency     String
    quantity     BigInt?     @default(1)
    openedAt     DateTime
    endedAt      DateTime
    offerer      String
    status       OfferStatus

    @@unique([tokenId, openedAt, offerer, status])
    @@index([tokenId, offerer])
}

model AptosActivity {
    id           String    @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    orderId      String?   @db.VarChar(64)
    tokenId      String    @db.VarChar(64)
    collectionId String    @db.VarChar(64)
    source       String?   @default("") @map("from")
    destination  String?   @default("") @map("to")
    txHash       String?   @default("")
    operation    Operation
    price        Float?
    createTime   DateTime

    @@index([collectionId, operation])
}

//**************************************************************************************************
// IC
//**************************************************************************************************
model IcToken {
    id              String @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    collectionId    String @db.VarChar(64)
    rawCollectionId String
    rawTokenId      String
    owner           String
    creator         String @default("")
    collection      String @default("")
    name            String @default("")
    description     String @default("")
    uri             String @default("")

    @@unique([rawCollectionId, rawTokenId])
    @@index([collectionId, owner])
}

model IcTokenFavorited {
    id           String @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    tokenId      String @db.VarChar(64)
    collectionId String @db.VarChar(64)
    favoritedBy  String

    @@index([tokenId, collectionId, favoritedBy])
}

//**************************************************************************************************
// FLOW
//**************************************************************************************************
model FlowToken {
    id              String @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    collectionId    String @db.VarChar(64)
    rawCollectionId String
    rawTokenId      String
    owner           String
    creator         String @default("")
    collection      String @default("")
    name            String @default("")
    description     String @default("")
    uri             String @default("")

    @@unique([rawCollectionId, rawTokenId])
    @@index([collectionId, owner])
}

model FlowTokenFavorited {
    id           String @id @default(dbgenerated("(uuid())")) @db.VarChar(64)
    tokenId      String @db.VarChar(64)
    collectionId String @db.VarChar(64)
    favoritedBy  String

    @@index([tokenId, collectionId, favoritedBy])
}

model EventOffset {
    id                          Int    @id @default(0)
    buy_event_excuted_offset    BigInt
    list_event_excuted_offset   BigInt
    delist_event_excuted_offset BigInt
    create_offer_excuted_offset BigInt @default(-1)
    accept_offer_excuted_offset BigInt @default(-1)
    cancel_offer_excuted_offset BigInt @default(-1)
}
